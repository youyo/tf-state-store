AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Terraform state store

Parameters:
  TfStateBucketNoncurrentVersionExpirationInDays:
    Type: Number
    Default: 731
  TfAdministratorKeysStatus:
    Type: String
    Default: Active
  TfAdministratorKeysSerial:
    Type: Number
    Default: 0

Resources:
  TfStateBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - NoncurrentVersionExpirationInDays: !Ref TfStateBucketNoncurrentVersionExpirationInDays
            Status: Enabled

  TfStateLockTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: LockID
          AttributeType: S
      KeySchema:
        - AttributeName: LockID
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      SSESpecification:
        SSEEnabled: true

  TfAdministrator:
    Type: AWS::IAM::User
    Properties:
      UserName: TerraformAdministrator
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AdministratorAccess

  TfAdministratorKeys:
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: !Ref TfAdministrator
      Status: !Ref TfAdministratorKeysStatus
      Serial: !Ref TfAdministratorKeysSerial

Outputs:
  TfStateBucketName:
    Value: !Ref TfStateBucket
  TfStateLockTableName:
    Value: !Ref TfStateLockTable
  TfAdministratorAccesskey:
    Value: !Ref TfAdministratorKeys
  TfAdministratorSecretAccesskey:
    Value: !GetAtt TfAdministratorKeys.SecretAccessKey
